<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mailchimp integration</title>
<style>
#mailchimpFrame {
    position: absolute;
    top: 50%;
    left: 50%;
    margin-right: -50%;
    transform: translate(-50%, -50%);
    width: 400px;
    height: 600px;
    border: 1px solid #ccc;
}
</style>
</head>
<body>
<h1>Mailchimp integration</h1>
<h2>Connection status</h2>
<span id="status"></span><span class="mcAccountLinked">, Account: <span id="accountDetails"></span></span>
<br>
<button id="link" class="mcAccountUnlinked" onclick="linkAccount()">Link Mailchimp account</button>
<button id="unlink" class="mcAccountLinked" onclick="unlinkAccount()">Unlink Mailchimp account</button>
<h2>Synchronized lists</h2>
<p class="mcAccountUnlinked">Link an account first...</p>
<table class="mcAccountLinked" border="1">
<thead>
<tr><th>Cloud docs list</th><th>Mailchimp list</th><th>&nbsp;</th></tr>
</thead>
<tbody id="lists"></tbody>
</table>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script>
var userId = 2;

$(function(){
    updateStatus();
});

function updateStatus(){
    $.get("mailchimpStatus.php", {user: userId}, function(data){
        $("#status").text(data.connected ? "Connected" : "Not connected");
        if (!data.connected) {
            $(".mcAccountLinked").hide();
            $(".mcAccountUnlinked").show();
            return;
        }
        $(".mcAccountLinked").show();
        $(".mcAccountUnlinked").hide();
        $("#accountDetails").text(data.accountDetails);

        var cdList = $("<select><option value='' disabled selected='selected'>Select cloud docs list<option value='+'>Create new list</option></select>");

        for (var i in data.cloudLists){
            var cl = data.cloudLists[i];
            cdList.append($("<option value='" + cl.id + "'>" + cl.title + " <i>(" + cl.count +  " emails)</i></option>"))
        }

        $("#lists").append($("<tr></tr>")).append($("<td></td>")).append(cdList);
    });
}

function linkAccount(){
    var url = "https://login.mailchimp.com/oauth2/authorize?response_type=code&client_id=755469067161&redirect_uri=https%3A%2F%2Fapi.hfinone.com%2Fmailchimp%2Fcomplete.php";
    $('<iframe id="mailchimpFrame" src="' + url + '" />')
        .appendTo('body');
}

function unlinkAccount(){
    $.ajax({
        url: "saveKey.php",
        data: {userId: userId},
        dataType: "json",
        success: function () {
            updateStatus();
        }});
}

// called from child window rendered by complete.php
function receiveCode(code) {
    $('#mailchimpFrame').remove();

    $.ajax({
        url: "saveKey.php",
        data: {userId: userId, apiKey: code},
        dataType: "json",
        success: function () {
            updateStatus();
        }});
}

</script>
</body>
</html>