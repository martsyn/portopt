<!DOCTYPE html>
<html>
<head>
    <title>Epic Optimization</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/4.9.0/css/bootstrap-slider.min.css">
    <style>
        #vis {
            width: 800px;
            height: 300px;
            border: 1px dashed #ccc;
        }
        input[type="number"] {
            width:64px;
        }
        th.mid,
        td.mid {
            text-align: center;
        }
        th.right,
        td.right {
            text-align: right;
        }
        th.optHeader {
            background: bisque;
        }
        th.statsHeader {
            background: lavender;
        }
    </style>
</head>
<body>
<div class="container">
<div class="jumbotron">
<h1>Optimization</h1>
</div>

    <script>
        roundingFraction = 1e4; // round to a base-point
        roundingPercent = roundingFraction*0.01;
        var funds = [];
        var returns = [];
    </script>

<form method="post">

<div class="row">
<div class="col-md-4">

    <p><label for='return'>Return:</label><br/><input name='return' id='return' data-slider-min='-1' data-slider-max='1' data-slider-step='0.1' data-slider-value='1'/></p>
    <p><label for='volatility'>Volatility:</label><br/><input name='volatility' id='volatility' data-slider-min='-1' data-slider-max='1' data-slider-step='0.1' data-slider-value='-1'/></p>
    <p><label for='slopeDeviation'>Slope deviation:</label><br/><input name='slopeDeviation' id='slopeDeviation' data-slider-min='-1' data-slider-max='1' data-slider-step='0.1' data-slider-value='0'/></p>
    <p><label for='posDeviation'>Positive semi-deviation:</label><br/><input name='posDeviation' id='posDeviation' data-slider-min='-1' data-slider-max='1' data-slider-step='0.1' data-slider-value='0'/></p>
    <p><label for='negDeviation'>Negative semi-deviation:</label><br/><input name='negDeviation' id='negDeviation' data-slider-min='-1' data-slider-max='1' data-slider-step='0.1' data-slider-value='0'/></p>
    <p><label for='drawdown'>Worst drawdown:</label><br/><input name='drawdown' id='drawdown' data-slider-min='-1' data-slider-max='1' data-slider-step='0.1' data-slider-value='0'/></p>


    <p><label for="benchmark">Benchmark correlation:</label><br/>
    <input id="benchmark" data-slider-min="-1" data-slider-max="1" data-slider-step="0.1" data-slider-value="0"/></p>
    <p><label>Old-school combos:</label>
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="setSharpe()">Sharpe-ratio</button>
        <button type="button" class="btn btn-default" onclick="setKRatio()">K-ratio</button>
    </div>
    <p></p>

<button type="button" onclick="optimize()">Optimize</button><br/>
<button type="button" onclick="recalculate()">Recalculate</button><br/>

</div>
<div class="col-md-8">

<table class="table-striped" width="100%">
<thead>
<tr><th>&nbsp;</th><th>&nbsp;</th><th class="mid optHeader" colspan="3">Optimization</th><th class="mid statsHeader" colspan="3">Stats</th></tr>
<tr><th>Fund</th><th class="mid">Allocation</th><th class="mid optHeader">Required</th><th class="mid optHeader">Minimum</th><th class="mid optHeader">Maximum</th>
    <th class="right statsHeader">Return</th><th class="right statsHeader">Volatility</th><th class="right statsHeader">Sharpe</th></tr>
</thead>
<tbody id="fundTable">
</tbody>
<tfoot>
<tr><th>Summary</th><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>
    <td id="summaryRor" class="right">&nbsp;</td><td id="summaryVolatility" class="right">&nbsp;</td><td id="summarySharpe" class="right">&nbsp;</td></tr>
</tfoot>
</table>
</div>
</div>

</form>

<p>
<div id="vis"></div>
</p>
</div>

<script>
    var spec = {
        "width": 760,
        "height": 260,
        "data": [{"name": "table"}],
        "scales": [
            {"name": "x", "type": "ordinal", "range": "width", "domain": {"data": "table", "field": "data.x"}},
            {"name": "y", "range": "height", "nice": true, "domain": {"data": "table", "field": "data.y"}}
        ],
        "axes": [
            {"type": "x", "scale": "x"},
            {"type": "y", "scale": "y"}
        ],
        "marks": [
            {
                "type": "line",
                "from": {"data": "table"},
                "properties": {
                    "enter": {
                        "x": {"scale": "x", "field": "data.x"},
                        "y": {"scale": "y", "field": "data.y"},
                        "stroke": {value: "red"}
                    }
                }
            }
        ]
    };
</script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/vega/1.5.0/vega.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/4.9.0/bootstrap-slider.min.js"></script>
<script type='text/javascript'>

var sliders = {};
var sliderIds = ["return","volatility","slopeDeviation","posDeviation","negDeviation","drawdown"];
var vis;

$(document).ready(function() {

    sliderIds.forEach(function (id){
        sliders[id] = new Slider("#" + id, {});
        sliders[id].element.name = id;
    });

//    $.get('api/funds.php', function(data){
    var mockApiQuery = (function(data){
        stats = data;
        for (var fundId in stats)
        {
            funds.push(fundId);
            returns.push(stats[fundId].returns);
        }

        var html = "";
        var runSum = 0.0;
        var i = 0;
        for (fundId in stats) {
            ++i;
            var stat = stats[fundId];
            var newSum = round(i/funds.length);
            var part = round(newSum - runSum);
            html += "<tr>"
                + "<td>" + fundId + "</td>"
                + "<td class='mid'><input type='number' id='weight" + fundId + "' min='0' max='100' step='0.01' value='" + part*100.0 + "' /></td>"
                + "<td class='mid'><input type='checkbox' id='req" + fundId + "' /></td>"
                + "<td class='mid'><input type='number' id='min" + fundId + "' min='0' max='100' step='0.01' value='0.00' /></td>"
                + "<td class='mid'><input type='number' id='max" + fundId + "' min='0' max='100' step='0.01' value='100.00' /></td>"
                + "<td class='right'>" + showPercents(stat.ror) + "</td>"
                + "<td class='right'>" + showPercents(stat.volatility) + "</td>"
                + "<td class='right'>" + showSharpe(stat.sharpe) + "</td>"
                + "</tr>\n";
            runSum = newSum;
        }
        $("#fundTable").html(html);

        recalculate();
    });

    mockApiQuery({"50009708":{"ror":0.11720571428571,"volatility":0.10515591234943,"sharpe":1.1145898662953,"returns":["0.02780","-0.00150","-0.00140","0.01990","0.06550","-0.01100","-0.02060","0.02570","-0.07290","0.03500","-0.00760","0.02300","0.04710","-0.01330","0.02970","0.02740","0.01520","-0.01830","0.01200","0.00470","-0.00390","-0.03580","0.01640","-0.00750","-0.01620","0.01130","0.00860","0.02250","-0.02430","-0.03490","-0.00660","-0.00360","0.02300","0.02060","-0.01280","0.00010","0.02190","0.03010","0.00780","0.03520","-0.00580","0.05190","-0.00310","0.05660","-0.01690","0.07210","-0.00060","0.04280","0.10520","0.01580","0.02920","-0.04900","-0.06090","-0.00200","0.04500","-0.00500","0.02470","-0.01720","0.04140","0.01660","0.00230","0.08750","0.01480",0,0,0,0,0,0,0]},"61151353":{"ror":0.11722285714286,"volatility":0.10516166400124,"sharpe":1.1146919198756,"returns":["0.02780","-0.00150","-0.00140","0.01990","0.06550","-0.01100","-0.02060","0.02570","-0.07290","0.03500","-0.00760","0.02300","0.04710","-0.01330","0.02970","0.02740","0.01520","-0.01830","0.01200","0.00470","-0.00390","-0.03580","0.01640","-0.00750","-0.01620","0.01130","0.00860","0.02250","-0.02430","-0.03490","-0.00660","-0.00360","0.02300","0.02060","-0.01280","0.00010","0.02190","0.03010","0.00780","0.03520","-0.00580","0.05190","-0.00310","0.05660","-0.01690","0.07210","-0.00060","0.04280","0.10520","0.01580","0.02920","-0.04900","-0.06090","-0.00200","0.04510","-0.00500","0.02470","-0.01720","0.04140","0.01660","0.00230","0.08750","0.01480",0,0,0,0,0,0,0]},"85784797":{"ror":0.083106857142857,"volatility":0.044661188763802,"sharpe":1.8608294907326,"returns":[0,0,0,0,0,0,0,"0.03846","0.02517","0.02010","0.02726","0.01567","0.01060","0.01269","0.00567","0.00752","0.01685","0.00350","-0.02093","0.01591","0.00794","0.02363","0.02938","-0.00333","-0.01914","0.03470","0.03876","0.02942","-0.01253","-0.00625","0.02354","0.00738","0.02914","0.02777","-0.02234","0.00210","-0.00489","0.00394","0.01025","0.00938","0.02541","0.02093","-0.00380","-0.00210","0.00430","0.00040","0.01100","0.00500","0.00300","0.00000","0.01200","0.00400","0.00300","0.00200","0.00070","0.00270","0.00010","0.00070","-0.00187","-0.00349","0.00444","0.00255","0.00660","-0.00010",0,0,0,0,0,0]},"68228019":{"ror":0.151884,"volatility":0.11722631874407,"sharpe":1.2956476124751,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,"-0.01580","0.08350","0.00720","0.03370","0.00630","0.00190","0.00400","-0.03570","-0.07420","0.11150","-0.00270","0.00880","0.05770","0.02730","0.03740","-0.00080","-0.05130","0.03700","0.00660","0.06210","0.03230","0.00460","0.06670","0.02390","0.04080","0.00390","0.04680","-0.00550","0.04460","0.03520","0.05990","-0.04650","0.06430","0.05230","0.05110","0.04130","-0.03450","0.05530","0.03960","0.00570","0.01240","0.01830","-0.02290","0.04730","-0.00650","0.03100","-0.04370","0.01854","-0.03940","0.03591","-0.06790","0.01664",0,0,0,0,0]},"52603728":{"ror":0.11386971428571,"volatility":0.093877392393548,"sharpe":1.2129620495673,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,"-0.02530","0.07850","-0.00160","0.02640","0.00760","-0.00650","0.01710","-0.01650","-0.04990","0.06670","-0.02120","-0.00450","0.04650","0.01560","0.02750","0.00200","-0.01670","0.01440","0.00000","0.05290","0.02150","0.01210","0.06850","0.01840","0.02440","0.00060","0.03890","-0.01620","0.04050","0.04110","0.04990","-0.02840","0.05310","0.04230","0.04100","0.03180","-0.01770","0.03630","0.03350","0.00330","0.00880","0.01520","-0.02130","0.04090","-0.00610","0.02510","-0.05430","0.01240","-0.02550","0.01914","-0.06110","0.00510","-0.00200",0,0,0,0]},"13848758":{"ror":0.13270457142857,"volatility":0.084582824177711,"sharpe":1.568930485813,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,"0.03110","0.05900","0.00170","0.02100","0.00680","0.01190","0.01370","0.00020","-0.03620","0.05530","0.00050","0.01020","0.03270","0.01850","0.03560","0.00190","-0.03500","0.02050","0.01400","0.05070","0.01550","0.00890","0.05030","0.01280","0.02760","0.01060","0.03260","-0.01250","0.02200","0.03590","0.03810","-0.04290","0.04930","0.04100","0.04700","0.03480","-0.01470","0.03760","0.04850","0.01780","0.01510","0.00310","0.00470","0.02830","0.01310","0.01930","-0.03870","0.01000","-0.01466","0.01107","-0.08230","0.03370","-0.00290",0,0,0,0]},"18437237":{"ror":0.095321142857143,"volatility":0.069933023930627,"sharpe":1.3630347652591,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,"0.02270","0.05030","-0.01230","0.01300","0.00840","0.00350","0.02710","0.01620","-0.01100","0.01430","-0.01780","-0.00040","0.01970","0.00670","0.02660","0.00470","-0.00100","-0.00290","0.00660","0.04390","0.00560","0.01600","0.05160","0.00710","0.01120","0.00740","0.02430","-0.02350","0.01780","0.04270","0.02710","-0.02270","0.03620","0.03030","0.03760","0.02570","0.00000","0.02090","0.04330","0.01620","0.01220","-0.00040","0.00680","0.02270","0.01400","0.01330","-0.04910","0.00760","-0.00222","-0.00086","-0.07610","0.02572","-0.01070",0,0,0,0]},"64020156":{"ror":0.13962,"volatility":0.062769051996756,"sharpe":2.2243445704296,"returns":["0.00515","0.04820","0.01695","0.02911","0.02881","-0.01462","0.00078","0.02028","0.03261","0.03449","0.04385","0.03856","0.03764","0.09213","0.03883","-0.01150","0.01517","0.02367","-0.00856","-0.00413","-0.01642","-0.00977","-0.02414","0.01742","-0.00171","0.01719","0.02800","0.00675","0.01175","0.00946","-0.01136","0.01026","0.03598","0.01021","0.01006","0.00718","0.01014","0.03935","-0.00183","-0.00069","0.01063","0.03129","-0.00949","0.00414","0.01114","0.00769","0.02141","0.02367","0.00893","0.01074","-0.00301","0.01012","0.00237","0.00132","0.01205","0.00461","0.00250","0.01190","0.00110","0.00280","-0.00047","0.00015","0.01050","0.00775","0.01021","0.00790","-0.00275",0,0,0]},"25959302":{"ror":0.12208628571429,"volatility":0.12921650314231,"sharpe":0.9448196069803,"returns":[0,"-0.06972","0.06013","0.09871","0.03969","-0.00167","-0.00459","-0.00167","-0.00167","-0.00167","-0.00542","-0.01577","0.10892","0.05871","0.05630","-0.05096","-0.00167","-0.00161","-0.00132","-0.00131","-0.00135","-0.00144","0.05880","0.02800","0.02210","0.03880","0.01420","-0.00670","-0.01580","-0.00380","-0.00370","-0.00370","-0.00370","-0.00373","-0.00380","0.00180","0.01448","0.09831","0.02505","0.03745","-0.00364","-0.00336","-0.00347","-0.00320","-0.00413","-0.00322","0.01863","0.06142","0.04578","-0.10740","0.08590","0.01244","0.01158","-0.02424","-0.00263","-0.00380","0.00480","-0.00609","0.06197","0.04532","-0.00410","-0.07902","0.07855","-0.01460","0.00090","-0.00430","-0.00260",0,0,0]},"1076539":{"ror":0.40330285714286,"volatility":0.1883368569606,"sharpe":2.1413910354639,"returns":[0,"0.12830","0.10840","0.14230","0.04610","0.22340","0.18210","0.10000","0.12860","0.14720","0.05390","0.08600","0.05390","0.04820","-0.01730","0.07470","0.04600","0.03320","0.00710","-0.00890","-0.02210","-0.01160","0.06970","0.03320","0.08200","0.01980","0.07090","0.06120","0.04460","0.01130","0.04030","0.05080","0.03460","-0.00900","0.03500","0.02690","-0.08930","0.03240","-0.03320","0.04500","-0.00820","-0.04330","0.01220","0.03570","0.02110","-0.00080","0.02990","0.02600","0.02840","0.00360","-0.00270","0.03040","0.01410","0.00910","0.00080","-0.01870","0.01510","0.05170","-0.10690","0.00210","0.07980","-0.00560","0.04210","0.06800","0.01130","-0.00770","-0.01060",0,0,0]},"99548767":{"ror":0.10236,"volatility":0.09356219657838,"sharpe":1.0940316040384,"returns":[0,"-0.05370","0.04430","0.06660","0.03560","-0.00180","-0.00800","-0.00180","-0.00100","-0.00170","-0.00440","-0.01140","0.06700","0.04150","0.04570","-0.00820","0.01710","-0.00160","-0.00410","-0.00130","-0.00140","-0.00140","0.04170","0.02010","0.01650","0.03900","0.03120","0.02040","-0.02220","-0.00280","-0.00270","-0.00270","-0.00270","-0.00270","-0.00280","0.00230","0.00910","0.07630","0.01920","0.04240","-0.00310","-0.00260","-0.00260","-0.00250","-0.00300","-0.00250","0.01320","0.04390","0.03280","-0.07970","0.06160","0.00890","0.00850","-0.01850","-0.00220","-0.00290","0.00280","-0.00440","0.04260","0.03080","-0.00300","-0.05550","0.05360","-0.01070","0.00150","-0.00330","-0.00220",0,0,0]},"7269211":{"ror":0.17728971428571,"volatility":0.093094363829922,"sharpe":1.9044086773031,"returns":[0,"0.02089","0.00842","0.02845","0.00160","0.12348","0.03915","0.00830","-0.00674","0.01614","0.01648","-0.00268","-0.02063","-0.00433","0.01849","0.04594","0.02530","-0.01992","-0.02488","0.02580","0.06252","0.01137","0.00415","-0.00683","0.03422","0.06944","0.02281","-0.02416","0.00424","0.04947","0.06659","0.03738","0.01696","0.01967","0.00808","-0.01796","0.02165","0.04113","-0.02733","0.03350","-0.01330","0.03548","0.03874","0.01241","0.00309","0.02304","0.05246","0.03361","0.02311","-0.02036","0.00922","-0.01649","0.01790","0.00686","0.00360","0.00693","0.04172","0.00484","0.04207","0.00540","0.01135","0.01586","0.04513","-0.03826","-0.01750","-0.00235","-0.01653",0,0,0]},"49571130":{"ror":0.13968,"volatility":0.062769412023009,"sharpe":2.2252876918585,"returns":["0.00520","0.04820","0.01700","0.02910","0.02880","-0.01460","0.00080","0.02030","0.03260","0.03450","0.04390","0.03860","0.03760","0.09210","0.03880","-0.01150","0.01520","0.02370","-0.00860","-0.00410","-0.01640","-0.00980","-0.02410","0.01740","-0.00170","0.01720","0.02800","0.00680","0.01180","0.00950","-0.01140","0.01030","0.03600","0.01020","0.01010","0.00720","0.01010","0.03940","-0.00180","-0.00070","0.01060","0.03130","-0.00950","0.00410","0.01110","0.00770","0.02140","0.02370","0.00890","0.01070","-0.00300","0.01010","0.00240","0.00130","0.01210","0.00460","0.00250","0.01190","0.00110","0.00280","-0.00050","0.00020","0.01050","0.00780","0.01020","0.00790","-0.00280",0,0,0]},"57639905":{"ror":0.075394285714286,"volatility":0.021812130682213,"sharpe":3.4565300755219,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,"-0.00100","0.00520","0.00410","0.00350","0.00590","-0.00010","0.00520","0.00100","0.00000","-0.00270","0.00330","0.00310","0.01100","0.01180","0.01480","0.00910","0.00630","0.01490","0.01670","0.02230","0.01600","0.01240","0.01530","0.01200","0.02470","0.01620","0.01870","0.01290","0.01600","0.00380","0.00330","0.00620","0.00510","0.01430","0.01150","0.00960","0.01060","0.00810","0.00970","0.00990","0.00710","0.00930","0.01110","0.00490","0.00300","0.00650","0.00180","0.00490",0,0,"0.00590","0.00430","0.00570","0.00460",0,0,0]},"7729044":{"ror":0.079434857142857,"volatility":0.045877004673321,"sharpe":1.7314743564558,"returns":["0.02820","0.00660","0.00850","0.02660","0.02070","-0.03040","-0.00390","0.02540","0.00310","0.03020","0.02150","-0.00140","0.02110","0.01070","0.01210","0.00580","0.01130","-0.00320","-0.00890","0.00020","-0.03730","-0.03130","0.03850","-0.00730","0.00400","0.01990","0.01100","0.00460","0.00190","-0.01570","0.01160","0.00800","0.01260","0.01700","0.00550","0.00800","0.01150","0.01320","0.00480","0.01340","0.01360","0.01850","-0.01270","0.01980","-0.00060","0.02080","0.01810","0.00680","0.00650","-0.00200","0.01600","0.00130","0.00270","0.01080","0.01080","-0.00530","0.01110","-0.00430","0.00660","0.00880","0.00280","-0.00070","0.02220","0.00430","0.00257","0.01170","-0.00490",0,0,0]},"61447860":{"ror":0.0011828571428571,"volatility":0.081428422405879,"sharpe":0.01452634237418,"returns":["0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.01670","0.00920","-0.02960","-0.04760","-0.00880","-0.04560","0.00880","0.00980","0.04570","0.01700","0.05290","-0.00490","0.06430","-0.04480","-0.03480","0.05040","0.00520","0.03830","0.00830","0.03440","0.03750","-0.04000","0.02010","-0.03170","0.02610",0,"-0.00770","-0.00840",0,"-0.03070","-0.04200",0,"-0.06000",0,"0.02460","0.00670","-0.04020","0.02810","-0.02040",0,0,0]},"41475626":{"ror":0.11242285714286,"volatility":0.047254770021617,"sharpe":2.3790795530574,"returns":["-0.00430","0.00970","0.02480","0.00690","0.01030","0.03690","-0.00800","-0.00340","0.00060","0.03030","0.01450","0.02740","-0.00010","-0.02600","0.03210","0.02580","0.03100","0.02140","0.00560","-0.00230","-0.00160","-0.01710","0.02740","0.00580","0.01890","0.01720","0.02440","0.00740","0.01510","0.00540","-0.00820","0.01310","0.00550","0.00210","-0.01130","0.01210","0.00200","0.02240","0.00960","0.02070","0.01730","0.01140","0.00120","0.02320","-0.01120","0.01260","0.02400","0.02220","0.00930","0.00270","0.01410","0.00360","0.00920","0.01590","-0.01730","-0.01250","0.01440","-0.00930","0.03220","0.00620","-0.00070","0.03500","0.01750","0.01630","-0.01010","0.01230","0.00890","0.00330",0,0]},"98755966":{"ror":0.058457142857143,"volatility":0.09729588115535,"sharpe":0.6008182685946,"returns":["0.03780","-0.00830","-0.02850","0.01740","0.00750","-0.04420","-0.03300","0.04440","0.00330","0.03080","0.00520","0.00500","0.04390","0.02160","0.00970","0.00980","0.00720","-0.00900","-0.02390","-0.02730","-0.06650","-0.01790","0.03170","0.01690","-0.01370","0.01230","0.02960","0.00470","0.01100","-0.05920","-0.01280","-0.04240","0.01940","0.00640","0.04960","-0.01410","0.00010","0.08960","0.00660","0.04300","-0.01470","0.02100","0.03160","0.03560","-0.02100","-0.00510","-0.00850","0.03140","0.01160","-0.01100","0.05690","-0.00870","0.00320","0.02260","0.03560","-0.02920","-0.00840","-0.03040","-0.00860","0.01310","0.00660","-0.01070","0.04410","0.03520","-0.02700","0.04060","-0.00250","-0.02600",0,0]},"55690796":{"ror":0.055594285714286,"volatility":0.097078631836175,"sharpe":0.57267273613934,"returns":["0.03670","-0.00840","-0.02870","0.01740","0.00880","-0.04480","-0.03290","0.04590","0.00330","0.03090","0.00540","0.00500","0.03830","0.01730","0.00780","0.00790","0.00730","-0.00930","-0.01960","-0.02750","-0.06860","-0.01830","0.03410","0.02060","-0.01610","0.01800","0.03250","0.00460","0.01130","-0.05930","-0.01240","-0.04340","0.01920","0.00600","0.04840","-0.01470","-0.00070","0.07360","0.00580","0.04710","-0.00630","0.01960","0.02980","0.03550","-0.02160","0.00330","-0.00740","0.02870","0.01060","-0.01030","0.05530","-0.00940","0.00310","0.02250","0.03380","-0.03390","-0.00950","-0.03670","-0.00960","0.01460","0.00660","-0.01070","0.04950","0.03890","-0.03050","0.04440","-0.00300","-0.03150",0,0]},"35416912":{"ror":0.26370857142857,"volatility":0.15196347420968,"sharpe":1.7353418168414,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,"0.03100","0.04200","0.02960","0.03440","0.05060","0.00570","0.07530","0.05760","0.02900","0.02360","0.04260","0.02380","0.05870","0.03690","0.05210","0.02270","0.02740","0.02150","0.00680","-0.00420","0.01340","0.04030","0.04950","0.02760","-0.03450","0.00960","0.12490","0.03470","0.08300","0.10460","0.08310","0.00050","-0.01890","0.01500","0.02120","-0.00700","-0.03840","0.05590","-0.02210","0.00020","0.04420","0.09520","0.12500","0.07450","0.00000","-0.01100","0.06150","-0.01250","0.00000","0.00580","0.01860","-0.11820","0.15780","-0.09640","-0.01590",0,0]},"77025658":{"ror":0.14158285714286,"volatility":0.12378256271645,"sharpe":1.143802923738,"returns":["0.05760","-0.06750","0.10410","0.04410","0.02160","-0.03560","0.00620","-0.02970","0.01220","0.01700","0.00620","0.03090","0.05450","0.04160","0.07750","0.02120","0.06090","0.00810","-0.03260","-0.00490","-0.08860","-0.06670","0.05790","0.04380","0.02540","0.06190","0.05830","0.02040","0.02380","-0.02800","0.00180","0.04190","0.01770","-0.00260","0.00700","0.05130","0.00070","0.05910","0.00530","0.06570","-0.00240","0.00620","0.00280","0.00710","-0.02230","-0.00350","0.00710","0.02530","0.02610","-0.04460","0.02980","0.01350","0.00190","0.00100","-0.00480","0.00000","0.01620","-0.00660","0.02270","0.01850","0.00620","-0.07570","0.07590","-0.01950","-0.01140","0.00290","-0.00950","0.01350",0,0]},"86178573":{"ror":0.058011428571429,"volatility":0.096100552441658,"sharpe":0.60365343484,"returns":["0.03510","-0.00840","-0.02890","0.01760","0.00850","-0.04600","-0.03350","0.05000","0.00350","0.03180","0.00580","0.00540","0.04430","0.02090","0.00940","0.00980","0.00790","-0.01080","-0.02400","-0.02730","-0.06550","-0.01760","0.02870","0.01750","-0.01340","0.01170","0.02900","0.00440","0.01070","-0.05950","-0.01310","-0.04270","0.01910","0.00580","0.04730","-0.01460","-0.00020","0.07820","0.00450","0.04980","-0.01120","0.02310","0.02920","0.03510","-0.02100","0.00270","-0.00890","0.03080","0.01130","-0.01150","0.05540","-0.00900","0.00270","0.02200","0.03500","-0.02930","-0.00650","-0.03120","-0.00860","0.02000","0.00670","-0.01080","0.04350","0.03440","-0.02700","0.04050","-0.00280","-0.02740",0,0]},"36696020":{"ror":0.030497142857143,"volatility":0.068295446228209,"sharpe":0.44654723764798,"returns":[0,0,0,0,0,0,"0.00060","0.02950","-0.00910","0.02260","0.02280","0.00200","0.03190","0.02180","0.01060","0.00880","0.01450","-0.00410","-0.00730","0.00110","-0.04930","-0.04920","0.03200","-0.04440","0.02190","0.05060","0.03160","0.01980","0.00110","-0.01640","0.00170","0.00450","0.00360","0.01250","0.01040","0.00040","0.00640","0.01090","-0.00510","0.00740","0.01160","0.01420","-0.00300","0.02410","0.00940","0.01550","0.01490","0.00850","0.00520","0.01090","0.02060","0.01210","0.01340","0.01080","0.01520","0.00620","-0.00410","0.00140","-0.02010","-0.01060","-0.07090","-0.02130","-0.01410","-0.02470","-0.00620","0.00480","-0.01780","-0.02420",0,0]},"26636080":{"ror":0.03612,"volatility":0.13034289919834,"sharpe":0.2771152108949,"returns":["0.05580","-0.00520","-0.01220","-0.00040","-0.00510","-0.05140","-0.00070","-0.07260","0.02830","-0.01850","0.04250","0.00840","0.04330","0.01770","0.04920","0.01390","0.02530","0.02910","0.05300","0.00460","-0.10820","-0.10440","0.07300","-0.03820","-0.00090","0.04120","0.02590","0.00010","-0.00240","-0.00960","0.01810","0.03500","0.01320","0.03990","-0.01720","-0.01750","0.01680","-0.01080","-0.01030","0.02770","-0.01110","0.04620","0.00590","0.02820","-0.00610","0.04810","0.02390","0.02450","-0.00410","-0.00390","0.06150","-0.03740","-0.09020","-0.02140","0.05880","0.00450","-0.03290","-0.07800","-0.01740","0.03450","0.02690","-0.03660","0.04110","-0.00910","0.01280","-0.01460","0.02440","-0.04420",0,0]},"67945254":{"ror":0.092468571428571,"volatility":0.078764035717128,"sharpe":1.1739948389727,"returns":["-0.02540","-0.00760","0.03970","0.04790","0.02510","0.01810","-0.03010","0.00270","0.02330","0.06300","0.02730","0.02520","0.02960","-0.04330","-0.01060","0.02200","0.04250","-0.03750","-0.03220","0.01180","0.00430","-0.00780","0.02790","0.00010","0.02960","0.01360","0.02070","0.01990","-0.01120","0.01910","-0.00610","0.01980","0.00980","0.00300","-0.01920","0.01820","0.00020","0.02850","0.00140","-0.01160","0.00550","0.00450","0.01840","-0.00800","0.01410","-0.00690","-0.01360","0.02190","0.00680","-0.01430","-0.01690","-0.01420","-0.01430","-0.01020","-0.00340","-0.00460","0.00890","0.05680","0.03670","0.05470","0.00300",0,"0.02360","0.04150","0.01170","0.02750","-0.03980","-0.00170",0,0]},"29154909":{"ror":0.050742857142857,"volatility":0.04296424332025,"sharpe":1.181048546919,"returns":["0.01880","0.01280","0.01380","-0.01280","0.00490","-0.04220","0.00010","-0.02720","-0.00220","0.02600","0.01880","-0.02840","0.02060","0.00240","0.00320","0.01120","0.00450","0.01130","0.00870","-0.00070","0.02480","-0.01890","-0.01060","0.01460","0.00040","0.00420","0.01300","0.00130","0.00830","0.03090","0.00310","-0.00840","0.00720","0.00710","-0.00880","0.00590","0.01370","0.00870","0.00990","-0.00340","-0.00220","0.00120","0.02950","0.00080","-0.00540","0.01090","0.01030","0.00650","0.01350","-0.00650","-0.00440","0.00420","0.00140","0.01150","0.00370","0.00890","0.00270","0.01030","0.00340","0.00020","0.02830","-0.00490","0.00770","0.00750","0.00080","0.00440","0.00670","-0.00160",0,0]},"30219613":{"ror":0.098742857142857,"volatility":0.21932509837114,"sharpe":0.45021230071793,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,"0.04300","0.04100","-0.02890","0.02220","-0.08070","-0.00410","-0.07050","-0.14180","-0.22900","0.12600","-0.00070","-0.04540","0.01110","0.00120","-0.09890","0.09440","-0.01450","0.02140","0.03020","0.08260","0.06040","-0.00870","0.09430","0.09400","0.07170","-0.02230","0.02050","0.02600","0.14630","-0.01780","0.05030","0.00960","0.02510","0.04130","0.05340","0.07950","0.04080","0.05800","0.00880","-0.01340","0.02870","0.01830","-0.03200","0.04590","-0.08640","-0.09280","-0.03040","-0.01760",0,"0.20840","0.04240","0.05110","0.01930","-0.07110","-0.08420",0,0]},"93565016":{"ror":0.10620171428571,"volatility":0.099728940203137,"sharpe":1.064903668578,"returns":[0,"0.02089","0.00842","0.02845","0.00160","0.12348","0.03915","0.00830","-0.00674",0,0,"0.04241","0.03023","-0.03146","0.00846","0.03106","0.01075","0.01255","-0.01673","0.01858","0.01959","0.03165","0.01072","-0.02986","-0.03034","0.01609","-0.03250","0.05537","0.01167","0.00075","0.01614","0.02464","0.03889","0.00996","-0.00841","-0.00519","0.00749","0.01643","0.03386","0.00030","0.02510","0.04636","0.03409","-0.01001","-0.04623","0.00709","0.02983","-0.05436","0.00864","0.02637","-0.04786","-0.05125","-0.02472","0.04494","-0.02972","-0.00259","-0.00432","0.03211","0.06580","0.00673","-0.02645","0.01873","-0.01403","-0.01085","0.02558","0.02471","0.01253","0.01664",0,0]},"68622463":{"ror":0.033548571428571,"volatility":0.069735470024886,"sharpe":0.481083319817,"returns":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,"0.00780","0.02650","-0.00540","0.02760","0.04490","0.05590","-0.04270","-0.01110","-0.01840","0.00650","0.00580","0.00060","-0.00170","0.02170","-0.00590","-0.00920","0.02620","0.02330","-0.00090","-0.00480","0.00850","-0.00050","0.01020","0.07370","-0.01840","0.01250","0.02690","-0.05780","-0.00140","0.00150","0.01250","0.00810","-0.00100","-0.01480","0.03940","0.00820","0.00220","-0.00950","0.01490","-0.01130","0.00870","0.04240","0.00920","-0.00760","-0.00420","-0.03910","-0.03720","-0.01470","0.00150","-0.01300","-0.00090",0,0]},"22726391":{"ror":0.16186285714286,"volatility":0.12369521357443,"sharpe":1.3085620087107,"returns":[0,0,0,0,0,"0.00180","-0.04090","0.02730","-0.03150","0.02510","0.02480","0.03790","0.12770","0.08240","0.02700","0.01530","0.01450","0.02090","0.03930","-0.01810","-0.09210","-0.08520","0.08680","-0.02170","0.05460","0.04000","0.04190","0.03090","0.00980","-0.05590","0.02820","0.01040","0.03470","0.03280","0.03500","-0.03050","0.01890","0.07480","0.01650","0.02700","0.03830","0.02910","-0.01070","0.01480","-0.01090","0.02030","0.01210","0.06720","-0.00780","0.04610","0.04830","0.00660","-0.01470","0.00770","0.03550","-0.01810","0.01460","-0.03300","0.04700","-0.01990","0.00170","-0.03140","0.04870","0.01510","0.00070","-0.00120","0.03140","-0.00370",0,0]},"80144237":{"ror":0.033462857142857,"volatility":0.096088647336399,"sharpe":0.34824985126189,"returns":["0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.00000","0.05350","0.00760","-0.02300","0.02840","-0.02230","-0.03470","0.02260","0.04260","0.01810","-0.05820","-0.01040","-0.04430","0.02570","0.04230","0.05070","-0.00180","0.03530","-0.00770","-0.00900","-0.01500","0.00000","0.00600","-0.05400","0.01600","-0.01400","-0.04900","-0.02000","-0.01000","0.00600","0.01100","0.00300","0.02000","0.03600","-0.03110","-0.07200","-0.00100","-0.03100","-0.00200","0.06000","0.04800","-0.02300","0.00200","0.05400","0.00000","0.00300","0.02800","0.03300","0.00100","0.02100","0.00500","0.00800","0.03190","-0.00190","0.04850","0.01050","0.01830","-0.04170","0.00750","-0.03220",0,0,0]}});
});

function resetSliders() {
    sliderIds.forEach(function (id){
        sliders[id].setValue(0, true, true);
    });
}

function setSharpe() {
    resetSliders();
    sliders.return.setValue(1, true, true);
    sliders.volatility.setValue(-1, true, true);
}

function setKRatio() {
    resetSliders();
    sliders.return.setValue(1, true, true);
    sliders.slopeDeviation.setValue(-1, true, true);
}

function optimize() {
    var fundParams = [];
    funds.forEach(function(id){
        fundParams.push(
            {
                "id": id,
                "required": $("#req" + id).prop("checked"),
                "min": $("#min" + id).val()*0.01,
                "max": $("#max" + id).val()*0.01
            })});

    var optParams = {};
    sliderIds.forEach(function (id){
        optParams[id] = sliders[id].getValue();
    });

    var data = {
        funds: fundParams,
        optType: "custom",
        optParams: optParams
    };

    $.ajax({
        type: "POST",
        url: "api/optimize.php",
        data: JSON.stringify(data),
        contentType: 'application/json; charset=utf-8',
        dataType: "json",
        success: function (result) {
            setWeights(result.weights);
            recalculate();
        }
    });
}

function round(x) {
    return Math.round(x*roundingFraction)/roundingFraction;
}

function roundPercents(x) {
    return Math.round(x*roundingPercent)/roundingPercent;
}

function showPercents(x) {
    return (x*100.0).toFixed(2);
}

function showSharpe(x) {
    return (x).toFixed(2);
}

function setWeights(weights) {
    var sum = 0;
    for (var i in weights)
        sum += weights[i];
    var scale = 1/sum;
    var runSum = 0;
    var prevSum = 0;
    for (i = 0; i < weights.length; ++i){
        runSum += weights[i]*scale;
        var runSumRounded = round(runSum);
        var part = round(runSumRounded - prevSum);
        prevSum = runSumRounded;
        $("#weight" + funds[i]).val(roundPercents(100.0*part));
    }
}

function fixWeights() {
    var weights = [];
    for (var i = 0; i < funds.length; ++i){
        weights.push(0.01*parseFloat($("#weight" + funds[i]).val()));
    }
    var sum = 0.0;
    for (i = 0; i < weights.length; ++i){
        weights[i] = round(weights[i]);
        sum += weights[i];
    }
    if (sum < 1.0 || sum > 1.0) {
        for (i = weights.length - 1; i >= 0; --i){
            sum -= round(weights[i]);
            if (sum <= 1.0) {
                weights[i] = round(1.0 - sum);
                break;
            }
            weights[i] = 0.0;
        }
    }
    setWeights(weights);
    return weights;
}

function calcStats(returns) {
    var sum = 0.0;
    for (var i = 0; i < returns.length; ++i)
        sum += returns[i];
    var mean = sum/returns.length;

    var devSqSum = 0.0;
    for (i = 0; i < returns.length; ++i)
        devSqSum += (returns[i] - mean)*(returns[i] - mean);

    var ror = sum/returns.length*12;
    var volatility = Math.sqrt(devSqSum/returns.length*12);

    return {ror: ror, volatility: volatility, sharpe: ror/volatility};
}

function recalculate() {
    var weights = fixWeights();

    var sumReturns = [];
    for (var j = 0; j < returns[0].length; ++j) {
        var agg = 0.0;
        for (var i = 0; i < weights.length; ++i) {
            agg += returns[i][j]*weights[i];
        }
        sumReturns.push(agg);
    }

    var stats = calcStats(sumReturns);

    $("#summaryRor").text(showPercents(stats.ror));
    $("#summaryVolatility").text(showPercents(stats.volatility));
    $("#summarySharpe").text(showSharpe(stats.sharpe));


    // no clue how to chart without x and y, so populate a separate array for vega
    var table = [];
    var sum = 0.0;
    for (j = 0; j < sumReturns.length; ++j) {
        sum += sumReturns[j];
        table.push({x: j, y: sum});
    }
    vg.parse.spec(spec, function (chart) {
        vis = chart({el: "#vis", data: {table:table}}).update();
    });
}
</script>
</body>
</html>